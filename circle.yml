#machine:
#  timezone:
#    Asia/Tokyo
#  environment:
#    # project ID
#    GCLOUD_PROJECT: "aerobic-arc-159407"
#
#deployment:
#  staging:
#    branch: master
#    commands:
#    # update gcloud components
#    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update
#    # decode and make service key
#    - echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
#    # 400 permition
#    - chmod 400 ${HOME}/gcloud-service-key.json
#    # activate auth account
#    - sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account circleci-deploy-manager@aerobic-arc-159407.iam.gserviceaccount.com --key-file ${HOME}/gcloud-service-key.json --project $GCLOUD_PROJECT
#    # set project ID
#    - sudo /opt/google-cloud-sdk/bin/gcloud config set project $GCLOUD_PROJECT
#    # show gcloud config
#    - sudo /opt/google-cloud-sdk/bin/gcloud config list
#    # install dependency module
#    - ls -la
#    # build for linux/x64
#    - make build
#    # ===debug===
#    - pwd
#    - ls -la
#    # show project info
#    - sudo /opt/google-cloud-sdk/bin/gcloud compute project-info describe
#    # deploy to compute engine
#    - sudo cat ${HOME}/.ssh/id_stg-api01
#    - sudo cat ${HOME}/.ssh/id_stg-api01.pub
#    - sudo /opt/google-cloud-sdk/bin/gcloud compute copy-files canaria-api canaria-user@stg-api01:~ --ssh-key-file ${HOME}/.ssh/id_stg-api01 --zone us-west1-b --project $GCLOUD_PROJECT
#    # Run by Supervisord

machine:
  timezone:
    Asia/Tokyo
  environment:
    # project ID
    GCLOUD_PROJECT: "aerobic-arc-159407"

dependencies:
  pre:
    - sudo add-apt-repository ppa:masterminds/glide -y
    - sudo apt-get update
    - sudo apt-get install glide -y
  override:
    - curl -o $HOME/go_appengine_1.9.48.zip https://storage.googleapis.com/appengine-sdks/featured/go_appengine_sdk_linux_amd64-1.9.48.zip
    - unzip -q -d $HOME $HOME/go_appengine_1.9.48.zip
    # decode and make service key
    - echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
    - gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json
    - gcloud config set project $GCLOUD_PROJECT
    - make glide
    - make deps

deployment:
  appengine:
    branch: master
    commands:
      - $HOME/go_appengine/appcfg.py update . --oauth2_access_token $(gcloud auth print-access-token 2> /dev/null)

machine:
  timezone:
    Asia/Tokyo
  environment:
    # project ID
    GCLOUD_PROJECT: "aerobic-arc-159407"

deployment:
  staging:
    branch: master
    commands:
    # update gcloud components
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update
    # decode and make service key
    - echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
    # activate auth account
    - sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account circleci-deploy-manager@aerobic-arc-159407.iam.gserviceaccount.com --key-file ${HOME}/gcloud-service-key.json
    # set project ID
    - sudo /opt/google-cloud-sdk/bin/gcloud config set project $GCLOUD_PROJECT
    # show gcloud config
    - sudo /opt/google-cloud-sdk/bin/gcloud config list
    # install dependency module
    - ls -la
    # build for linux/x64
    - make build
    # ===debug===
    - pwd
    - ls -la
    # show project info
    - sudo /opt/google-cloud-sdk/bin/gcloud compute project-info describe
    # deploy to compute engine
    - sudo cat ${HOME}/.ssh/id_stg-api01
    - sudo cat ${HOME}/.ssh/id_stg-api01.pub
    - sudo /opt/google-cloud-sdk/bin/gcloud compute copy-files canaria-api canaria-user@stg-api01:~ --ssh-key-file ${HOME}/.ssh/id_stg-api01 --zone us-west1-b
    # Run by Supervisord
machine:
  timezone:
    Asia/Tokyo
  environment:
    # project ID
    GCLOUD_PROJECT: "canaria-io"

dependencies:
  pre:
    - sudo add-apt-repository ppa:masterminds/glide -y
    - sudo apt-get update
    - sudo apt-get install glide -y
    - export GOPATH=$(pwd)
    - echo $GOPATH
  override:
    #- curl -o $HOME/go_appengine_1.9.54.zip https://storage.googleapis.com/appengine-sdks/featured/go_appengine_sdk_linux_amd64-1.9.54.zip
    #- unzip -q -d $HOME $HOME/go_appengine_1.9.54.zip
    # decode and make service key
    - echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
    - sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account integration-deploy-manager@canaria-io.iam.gserviceaccount.com --key-file ${HOME}/gcloud-service-key.json
    - sudo /opt/google-cloud-sdk/bin/gcloud config set project $GCLOUD_PROJECT
    - make deps

test:
  override:
    - ./dummy_test_script.sh

deployment:
  appengine:
    branch: [master, develop]
    commands:
      - sudo /opt/google-cloud-sdk/platform/google_appengine/goapp deploy -application canaria-io -version blue ./app/stg.yaml
      # - sudo /opt/google-cloud-sdk/bin/gcloud app deploy --version blue gae/app/prd.yaml --quiet --project canaria-io
